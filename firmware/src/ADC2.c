/*
--|----------------------------------------------------------------------------|
--| FILE DESCRIPTION:
--|   ADC2.c provides the implementation for initializing ADC2.
--|   
--|   ADC2 channel 2 reads the audio input signal on pin PA5.
--|  
--|----------------------------------------------------------------------------|
--| REFERENCES:
--|   STM32F334xx Reference Manual, page 104 (RCC)
--|   STM32F334xx Reference Manual, page 211 (ADC)
--|
--|----------------------------------------------------------------------------|
*/

/*
--|----------------------------------------------------------------------------|
--| INCLUDE FILES
--|----------------------------------------------------------------------------|
*/

#include "stm32f3xx.h"

/*
--|----------------------------------------------------------------------------|
--| PRIVATE DEFINES
--|----------------------------------------------------------------------------|
*/

/* None */

/*
--|----------------------------------------------------------------------------|
--| PRIVATE TYPES
--|----------------------------------------------------------------------------|
*/

/* None */

/*
--|----------------------------------------------------------------------------|
--| PRIVATE CONSTANTS
--|----------------------------------------------------------------------------|
*/

/* None */

/*
--|----------------------------------------------------------------------------|
--| PRIVATE VARIABLES
--|----------------------------------------------------------------------------|
*/

/* None */

/*
--|----------------------------------------------------------------------------|
--| PUBLIC VARIABLES
--|----------------------------------------------------------------------------|
*/

/* None */

/*
--|----------------------------------------------------------------------------|
--| PRIVATE HELPER FUNCTION PROTOTYPES
--|----------------------------------------------------------------------------|
*/

/* None */

/*
--|----------------------------------------------------------------------------|
--| PUBLIC FUNCTION DEFINITIONS
--|----------------------------------------------------------------------------|
*/

void ADC2_Init(void)
{
    // enable ADC 1 and 2 (you can only enable them both at once)
    RCC->AHBENR |= RCC_AHBENR_ADC12EN;

    // PLL clock divided by 2?
    RCC->CFGR2 |= RCC_CFGR2_ADCPRE12_4 | RCC_CFGR2_ADCPRE12_0;

    // enable GPIO port A
    RCC->AHBENR |= RCC_AHBENR_GPIOAEN;

    // enable the ADC voltage regulator
    ADC2->CR |= ADC_CR_ADVREGEN_0;

    // first conversion is channel 2, the audio input
    ADC2->SQR1 |= ADC_SQR1_SQ1_1;

    // set calibration to single ended
    ADC2->CR &= ~ADC_CR_ADCALDIF;

    // start the calibration
    ADC2->CR |= ADC_CR_ADCAL;

    while (ADC2->CR & ADC_CR_ADCAL)
    {
        // wait for the calibration to complete
    }

    // enable ADC2
    ADC2->CR |= ADC_CR_ADEN;

    while (!(ADC2->ISR & ADC_ISR_ADRDY))
    {
        // wait until the ADC is ready
    }
}

/*
--|----------------------------------------------------------------------------|
--| PRIVATE HELPER FUNCTION DEFINITIONS
--|----------------------------------------------------------------------------|
*/

/* None */
